<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>Online MCQ Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="assets/css/bootstrap.css" rel="stylesheet">
    <link href="assets/css/style.css" rel="stylesheet">
    <link href="assets/css/responsive.css" rel="stylesheet">
    <style>
      body {
        background: #f7fafc;
        font-family: 'Inter', Arial, sans-serif;
        min-height: 100vh;
      }
      .test-container {
        max-width: 700px;
        margin: 40px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.08);
        padding: 2.5rem 2rem;
      }
      .test-title {
        text-align: center;
        font-size: 2.2rem;
        font-weight: 700;
        color: #4a7c59;
        margin-bottom: 2.5rem;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #e2f0e4;
        padding-bottom: 0.7rem;
      }
      .question-card {
        background: linear-gradient(135deg, #f8fafc, #e2f0e4);
        border-radius: 14px;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.07);
        padding: 1.5rem 1.2rem;
        margin-bottom: 1.5rem;
        border-right: 5px solid #43c522;
      }
      .question-card b {
        color: #485dbd;
        font-size: 1.1rem;
      }
      .option-label {
        display: block;
        padding: 0.5rem 1rem;
        margin-bottom: 0.5rem;
        background: #f3f6f9;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1rem;
        transition: background 0.2s;
      }
      .option-label:hover {
        background: #e2f0e4;
      }
      .submit-btn {
        display: block;
        width: 100%;
        font-size: 1.2rem;
        padding: 0.8rem 0;
        border-radius: 10px;
        margin: 2rem 0 1rem 0;
        background: linear-gradient(90deg, #abc7ac, #764ba2);
        border: none;
        color: #fff;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.09);
      }
      .result {
        text-align: center;
        font-size: 1.3rem;
        margin-top: 1.5rem;
      }
    </style>
</head>
<body>
  <script>
    // Require login for test page
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
    }
  </script>
  <div class="test-container">
    <div class="test-title">Online MCQ Test</div>
    <div id="testArea">Loading questions...</div>
    <button id="submitBtn" class="submit-btn" style="display:none">Submit Test</button>
    <div id="result" class="result"></div>
  </div>
  <script src="config.js"></script>
<script>
// Get course ID from URL query string, support both 'course' and 'course_id', fallback to 1 if not present
const urlParams = new URLSearchParams(window.location.search);
const course = urlParams.get('course') || urlParams.get('course_id') || 1;
let questions = [];
let userAnswers = {};

function fetchWithAuth(url) {
  return fetch(url, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
}

// Only check 'completed' field for eligibility
fetchWithAuth(`${window.API_BASE_URL}/api/courses/progress/${course}`)
  .then(res => res.json())
  .then(progressData => {
    console.log('Progress Data:', progressData);
    if (!progressData.completed) {
      document.getElementById('testArea').innerHTML = `<div class="alert alert-warning" style="font-size:1.2rem; text-align:center;">You cannot attempt this course test until you have completed all videos.<br>Please complete all videos first.</div>`;
      document.getElementById('submitBtn').style.display = 'none';
    } else {
      // Eligible: fetch and render test
      fetch(`${window.API_BASE_URL}/api/test/mcqs/${course}`)
        .then(res => res.json())
        .then(data => {
          questions = data.questions;
          renderQuestions();
          document.getElementById('submitBtn').style.display = 'block';
        });
    }
  })
  .catch(() => {
    document.getElementById('testArea').innerHTML = `<div class="alert alert-danger">There was a problem loading your progress. Please try again.</div>`;
    document.getElementById('submitBtn').style.display = 'none';
  });

function renderQuestions() {
  const testArea = document.getElementById('testArea');
  testArea.innerHTML = questions.map((q, idx) => `
    <div class="question-card">
      <div class="mb-2"><b>Question ${idx+1}:</b> ${q.question_text}</div>
      <div>
        ${q.options.map((opt, oidx) => `
          <label class="option-label">
            <input type="radio" name="q${idx}" value="${opt}" style="margin-left:8px;" onchange="userAnswers[${idx}] = this.value"> ${opt}
          </label>
        `).join('')}
      </div>
    </div>
  `).join('');
}

document.getElementById('submitBtn').onclick = function() {
  let score = 0;
  questions.forEach((q, idx) => {
    if (userAnswers[idx] && userAnswers[idx] === q.correct_answer) score++;
  });
  const resultText = `Your correct answers: <span class="text-success">${score}</span> / ${questions.length}`;
  document.getElementById('result').innerHTML = resultText;
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });

  // Passing criteria (e.g., 70% correct)
  const passingScore = Math.ceil(questions.length * 0.1);
  if (score >= passingScore) {
    document.getElementById('result').innerHTML += '<br><span class="text-success">Congratulations! You have passed the test. Your certificate will be generated.</span>';
    // Send result to backend for certificate
    fetch(`${window.API_BASE_URL}/api/test/result`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        ...(token ? { Authorization: 'Bearer ' + token } : {})
      },
      body: JSON.stringify({
        course: course,
        score: score,
        total: questions.length
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById('result').innerHTML += '<br><span class="text-success">(Result saved on server)</span>';
      }
      document.getElementById('result').innerHTML += '<br><a href="profile.html" class="btn btn-primary mt-3">Return to Profile</a>';
    });
  } else {
    document.getElementById('result').innerHTML += '<br><span class="text-danger">You did not pass the test.</span>';
    document.getElementById('result').innerHTML += '<br><button id="tryAgainBtn" class="btn btn-warning mt-3">Try Again</button>';
    setTimeout(() => {
      const btn = document.getElementById('tryAgainBtn');
      if (btn) btn.onclick = () => window.location.reload();
    }, 100);
  }
};
</script>
</body>
</html>